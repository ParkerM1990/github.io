<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<title>Mapa Parkomat√≥w - Wyszukiwanie</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
html, body { height: 100%; margin: 0; padding: 0; }
#map { position: absolute; top: 0; bottom: 0; left: 0; right: 0; }
#refreshBtn { position: absolute; bottom: 120px; left: 10px; z-index:1001; background:#007bff; color:#fff; border:none; padding:10px; cursor:pointer; border-radius:5px; }
/* ... pozosta≈Çe style jak w Twoim kodzie ... */
</style>
</head>
<body>

<div id="filter">
  <label>Wybierz strefy:</label><br/>
  <select id="strefaSelect" multiple size="5"></select>
</div>

<div id="map"></div>
<div id="sidebarToggle">‚ò∞</div>
<div id="sidebar">
  <div id="sidebarHeader">
    <span class="sidebar-title">üìç Lista parkomat√≥w</span>
    <button id="sidebarClose">√ó</button>
  </div>
  <div class="sidebar-search">
    <input type="text" id="sidebarSearch" placeholder="Szukaj po numerze lub kodzie..." />
  </div>
  <div id="sidebarContent"></div>
</div>

<div class="legend">
  <div><span style="background: green;"></span> Aktywny parkomat</div>
  <div><span style="background: red;"></span> Zdemontowany parkomat</div>
  <div><span style="background: black;"></span> Zdemontowane fundamenty</div>
</div>

<button id="refreshBtn">Od≈õwie≈º</button>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const mapa = L.map("map").setView([52.2297, 21.0122], 13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: "&copy; OpenStreetMap contributors" }).addTo(mapa);

  let parkomatyData = [], fundamentyId = [], zdemontowaneId = [], markersMap = {}, zdemontowaneFoto = {}, fundamentyFoto = {}, locationMarker = null;

  const fundamentyUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRBVT8MoLx1Zaft1gTfqkWwdoSqDBKiUk8IFI7-D4NxriMKWsPSJdfayhncS21HaNj7Eg7Y0pGrr0oE/pub?gid=1351898769&single=true&output=csv'; 
  const zdemontowaneUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRtVA5KWhFAp6bRgBFQH-oDmJgGlbzj3F91-vw1wvTKMCwpO-DjRZ3JoopFm2UarhmInDFPcUzPhz1D/pub?gid=1398714071&single=true&output=csv'; 
  const parkomatyUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSFwA2SPG1zKGbpx5jDLiT6bBIS3RHvZwL4b_6WeI6bdTQCoe0FJR0Ydgqzpb0UtvS42ngSopzN5NxE/pub?output=csv';

  function watchLocation() {
    if (!navigator.geolocation) return;
    navigator.geolocation.watchPosition(pos => {
      const { latitude, longitude } = pos.coords;
      if(locationMarker) mapa.removeLayer(locationMarker);
      locationMarker = L.circleMarker([latitude, longitude], { radius:10, color:"blue", fillOpacity:0.8 }).addTo(mapa).bindPopup("Twoja lokalizacja");
    });
  }
  watchLocation();

  function loadParkomaty() {
    Papa.parse(parkomatyUrl, { download:true, header:true, complete:function(results){
      parkomatyData = results.data.map(row => ({
        kod: String(row['Kod']||'').toUpperCase().trim(),
        numer: String(row['Numer']||'').toUpperCase().trim(),
        lon: parseFloat((row['X']||'0').replace(',','.')),
        lat: parseFloat((row['Y']||'0').replace(',','.')),
        adres: String(row['Adres']||'').trim(),
        strefa: String(row['Strefa']||'Brak').trim()
      }));
      updateStrefy();
      updateMarkers();
      createSidebar();
      loadZdemontowane();
    }});
  }

  function loadZdemontowane() {
    Papa.parse(zdemontowaneUrl, { download:true, header:true, complete:function(results){
      zdemontowaneId=[]; zdemontowaneFoto={};
      results.data.forEach(row=>{
        const id = String(row['Numer zdemontowanego parkomatu np. Z180512 albo O050123']||'').toUpperCase().trim();
        const link = row['Zdjƒôcie parkomatu z numerem'];
        if(id) { 
          zdemontowaneId.push(id); 
          if(link && link.includes("open?id=")){ 
            const imgId = link.split("id=")[1]; 
            zdemontowaneFoto[id] = `https://drive.google.com/thumbnail?id=${imgId}&sz=w500`; 
          } 
        }
      });
      updateMarkers();
      loadFundamenty();
    }});
  }

  function loadFundamenty() {
    Papa.parse(fundamentyUrl, { download: true, header: true, complete: function(results) {
      fundamentyId = [];
      fundamentyFoto = {};
      results.data.forEach(row => {
        const id = String(row['Numer odtworzonego fundamentu np. A010123 albo 1050123'] || '').toUpperCase().trim();
        const link = row['Zdjƒôcie odtworzonego fundamentu'];
        if (id) {
          fundamentyId.push(id);
          if (link && link.includes("open?id=")) {
            const imgId = link.split("id=")[1];
            fundamentyFoto[id] = `https://drive.google.com/thumbnail?id=${imgId}&sz=w500`;
          }
        }
      });
      updateMarkers();
    }});
  }

  function updateStrefy(){
    const strefy = [...new Set(parkomatyData.map(p=>p.strefa))].sort();
    const select = document.getElementById('strefaSelect'); select.innerHTML='';
    strefy.forEach(s=>{ 
      const option=document.createElement('option'); 
      option.value=s; option.text=s; 
      select.appendChild(option); 
    });
    select.addEventListener('change',()=>{ updateMarkers(); createSidebar(); });
  }

  function updateMarkers() {
    const selectedStrefy = Array.from(document.getElementById('strefaSelect').selectedOptions).map(o => o.value);

    parkomatyData.forEach(p => {
      const kod = (p.kod || '').toUpperCase().trim();
      const numer = (p.numer || '').toUpperCase().trim();
      if (!kod && !numer) return;

      if (selectedStrefy.length>0 && !selectedStrefy.includes(p.strefa)) {
        const key = kod || numer;
        if (markersMap[key]) {
          mapa.removeLayer(markersMap[key]);
          delete markersMap[key];
        }
        return;
      }

      const isFundament = fundamentyId.includes(kod) || fundamentyId.includes(numer);
      const isZdemontowany = zdemontowaneId.includes(kod) || zdemontowaneId.includes(numer);

      let kolor = 'green';
      if (isZdemontowany) kolor='red';
      if (isFundament) kolor='black';

      const fotoDem = zdemontowaneFoto[kod] || zdemontowaneFoto[numer] || '';
      const fotoFund = fundamentyFoto[kod] || fundamentyFoto[numer] || '';

      const popup = `<b>Parkomat:</b> ${p.kod} / ${p.numer}<br/>
<b>Adres:</b> ${p.adres}<br/>
<b>Strefa:</b> ${p.strefa}` +
(fotoDem ? `<br><a href="${fotoDem}" target="_blank"><img src="${fotoDem}" style="width:100px; height:auto; cursor:pointer;" referrerpolicy="no-referrer"></a>`:'') +
(fotoFund ? `<br><a href="${fotoFund}" target="_blank"><img src="${fotoFund}" style="width:100px; height:auto; cursor:pointer;" referrerpolicy="no-referrer"></a>`:'');

      const key = kod || numer;
      if (markersMap[key]) {
        markersMap[key].setStyle({ color: kolor });
        markersMap[key].bindPopup(popup);
      } else {
        const marker = L.circleMarker([p.lat, p.lon], { radius: 8, color: kolor, fillOpacity: 0.8 }).addTo(mapa);
        marker.bindPopup(popup);
        markersMap[key] = marker;
      }
    });
  }

  // Sidebar i wyszukiwarka jak w Twoim kodzie
  function createSidebar(filter=''){
    const container=document.getElementById('sidebarContent'); container.innerHTML='';
    const grouped={};
    parkomatyData.forEach(p=>{
      const text=(p.kod+' '+p.numer+' '+p.adres).toUpperCase();
      if(filter && !text.includes(filter.toUpperCase())) return;
      if(!grouped[p.strefa]) grouped[p.strefa]=[];
      grouped[p.strefa].push(p);
    });
    for(const strefa in grouped){
      const group=document.createElement('div'); group.className='strefa-group';
      const header=document.createElement('div'); header.className='strefa-header'; header.textContent=`Strefa: ${strefa}`;
      const list=document.createElement('div'); list.style.display='none';
      header.addEventListener('click',()=>{ list.style.display=list.style.display==='none'?'block':'none'; });
      grouped[strefa].forEach(p=>{
        const item=document.createElement('div'); item.className='parkomat-link'; item.textContent=`${p.kod} / ${p.numer}`;
        item.addEventListener('click',()=>{
          mapa.setView([p.lat,p.lon],16);
          if(window.tempTooltip){ mapa.removeLayer(window.tempTooltip); clearTimeout(window.tooltipTimeout); }
          window.tempTooltip = L.tooltip({ permanent:true, direction:'top', className:'custom-tooltip' })
            .setLatLng([p.lat,p.lon])
            .setContent(`<b>${p.kod} / ${p.numer}</b><br>${p.adres}`).addTo(mapa);
          window.tooltipTimeout=setTimeout(()=>{ mapa.removeLayer(window.tempTooltip); window.tempTooltip=null; },5000);
          document.querySelectorAll(".parkomat-link").forEach(el=>el.classList.remove("active"));
          item.classList.add("active");
        });
        list.appendChild(item);
      });
      group.appendChild(header); group.appendChild(list); container.appendChild(group);
    }
  }

  document.getElementById('sidebarSearch').addEventListener('input', function(){ createSidebar(this.value); });
  const sidebar = document.getElementById('sidebar');
  document.getElementById('sidebarToggle').addEventListener('click',()=>sidebar.classList.toggle('open'));
  document.getElementById('sidebarClose').addEventListener('click',()=>sidebar.classList.remove('open'));
  document.addEventListener('click', function(e){
    if(sidebar.classList.contains('open') && !sidebar.contains(e.target) && !document.getElementById('sidebarToggle').contains(e.target)) sidebar.classList.remove('open');
  });
  document.getElementById('refreshBtn').addEventListener('click', loadZdemontowane);

  loadParkomaty();
});
</script>
</body>
</html>
