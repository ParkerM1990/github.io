<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Mapa Parkomatów</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    .legend {
  position: absolute;
  bottom: 30px;
  left: 10px;
  background: white;
  padding: 10px;
  border-radius: 5px;
  font-size: 14px;
  line-height: 18px;
  color: #333;
  z-index: 1000; /* <-- dodajemy to! */
  box-shadow: 0 0 5px rgba(0,0,0,0.4); /* lepsza widoczność */
}
.legend div {
  display: flex;
  align-items: center;
}
.legend div span {
  width: 18px;
  height: 18px;
  margin-right: 5px;
  display: inline-block;
}
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="legend">
    <div><span style="background: green;"></span> Aktywny parkomat</div>
    <div><span style="background: red;"></span> Zdemontowany parkomat</div>
  </div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script>
    const mapa = L.map("map").setView([52.2297, 21.0122], 13); // Warszawa

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap",
    }).addTo(mapa);

    const linkDoCsv = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRtVA5KWhFAp6bRgBFQH-oDmJgGlbzj3F91-vw1wvTKMCwpO-DjRZ3JoopFm2UarhmInDFPcUzPhz1D/pub?gid=1398714071&single=true&output=csv';

    let zdemontowaneId = [];

    Papa.parse(linkDoCsv, {
      download: true,
      header: true,
      complete: function(results) {
        const wpisy = results.data;
        wpisy.forEach(wpis => {
          const numer = wpis['Numer zdemontowanego parkomatu np. Z180512 albo O050123'];
          if (numer) {
            const cleanNumer = numer.toUpperCase().replace(/\s/g, '');
            zdemontowaneId.push(cleanNumer);
          }
        });

        // Wczytanie danych z parkomaty.json:
        fetch("parkomaty.json")
          .then((res) => res.json())
          .then((dane) => {
            dane.forEach((p) => {
              const idy = [
                (p.kod || '').toUpperCase(),
                (p.numer || '').toUpperCase(),
                (p.id || '').toUpperCase()
              ];

              const czyZdemontowany = idy.some(id => zdemontowaneId.includes(id));
              const kolor = czyZdemontowany ? "red" : "green";

              const marker = L.circleMarker([p.lat, p.lon], {
                radius: 8,
                color: kolor,
                fillOpacity: 0.8,
              }).addTo(mapa);

              const formularzLink = `https://docs.google.com/forms/d/e/1FAIpQLSfC3S9QAAhe74E__u0Ni8UQnwrj9EAXjhxuzDbYsx1Z2gRn9Q/viewform?usp=pp_url&entry.1769843837=${p.id}`;

              marker.bindPopup(`
                <b>Parkomat:</b> ${p.kod} / ${p.numer}<br/>
                <b>Adres:</b> ${p.adres}<br/><br/>
                <a href="${formularzLink}" target="_blank">Zgłoś demontaż</a>
              `);
// Dodajemy label (tooltip widoczny cały czas):
marker.bindTooltip(`${p.kod}`, {
  permanent: true,
  direction: 'right',
  className: 'parkomat-label'
});
            });
          });
      }
    });
  </script>
</body>
</html>
